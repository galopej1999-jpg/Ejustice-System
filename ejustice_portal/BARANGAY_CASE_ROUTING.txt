BARANGAY CASE ROUTING IMPLEMENTATION - OPTION A
================================================

WHAT WAS IMPLEMENTED
====================

The system now routes ALL online complaints through the Barangay module first,
aligning with Philippine Katarungan Pambarangay law which requires cases to go
through Barangay mediation before escalation.

WORKFLOW CHANGES
================

BEFORE (Two Separate Systems):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Online Complainant â†’ Police Blotter directly
                    âŒ Barangay bypassed
                    âŒ No mediation opportunity

Barangay Staff â†’ Manual entry only
                 âŒ No online filing integration

AFTER (Unified Barangay-First Approach):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Online Complainant â†’ file_case.php
                     â†“
                Create in 'cases' table with stage='barangay_initial'
                     â†“
                Create linked 'barangay_records' entry
                     â†“
                Appears in BARANGAY DASHBOARD
                     â†“
                Barangay Lupon processes mediation
                     â†“
                Settled? YES â†’ Generate Kasunduan, close case
                Settled? NO  â†’ Generate CFA, escalate to Police Blotter
                     â†“
                Police handles formal investigation
                     â†“
                Court escalation if needed


DATABASE CHANGES
================

New SQL Migration: sql/004_add_barangay_case_routing.sql

1. ALTER TABLE cases:
   - Added barangay_id (links online case to barangay)
   - Added barangay_record_id (links case to barangay_records)
   - New stage: 'barangay_initial' (cases awaiting barangay processing)
   - New statuses: 'PENDING_BARANGAY', 'FILED'

2. ALTER TABLE barangay_records:
   - Added online_case_id (reverse link to online case)
   - New status: 'WAITING_FOR_BARANGAY'
   - Supports both manual entry and online-filed cases

IMPLEMENTATION DETAILS
======================

FILE: public/file_case.php
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CHANGES:
- Added barangay_id field to form (required)
- Complainants now SELECT their barangay when filing
- Creates TWO records in single transaction:
  1. cases table (stage='barangay_initial', status='PENDING_BARANGAY')
  2. barangay_records table (status='ACTIVE')
- Links both records together

FORM ADDITIONS:
- ğŸ˜ï¸ Barangay Selection dropdown (populated from barangay_info table)
- Improved UI with instructions about Katarungan Pambarangay
- Success message shows both case number and barangay record number

EXAMPLE FLOW:
1. Complainant selects Barangay: "Barangay Maharlika, Quezon City"
2. Fills incident details, respondent info, category
3. Submits form
4. System creates:
   - Online case: BLT-2025-1234 (in 'cases' table)
   - Barangay record: BR-202511-00001 (in 'barangay_records' table)
5. Both records linked bidirectionally


FILE: public/barangay_dashboard.php
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CHANGES:
- Added query for online-filed pending cases
- New stat card: "Online Filed" showing count
- New section: "Online-Filed Cases Pending Assignment"
- Displays table of pending online cases
- Each case has "Process" button linking to mediation page

NEW STATISTICS:
- $onlinePending = Count of cases with stage='barangay_initial'
- Quick action button to view these cases
- Alert notification when online cases arrive


CASE STATUS FLOW
================

When complaint filed online:

1. INITIAL STATE:
   cases.stage = 'barangay_initial'
   cases.status = 'PENDING_BARANGAY'
   barangay_records.status = 'ACTIVE'

2. BARANGAY PROCESSES:
   barangay_records.status = 'MEDIATION_IN_PROGRESS'
   (tracked via mediation_efforts table)

3. IF SETTLED:
   barangay_records.status = 'SETTLED'
   barangay_settlements created (Kasunduan)
   cases.status = 'RESOLVED' (or similar)
   âœ… Case closed

4. IF NOT SETTLED:
   barangay_records.status = 'ESCALATED'
   barangay_cfa created (Certificate to File Action)
   escalateToPoliceBlotter() called automatically
   â†’ New police case created: PB-YYYYMM-NNNNN
   â†’ cases record updated with police reference
   âœ… Escalated to Police


QUERY EXAMPLES
==============

Get all online-filed cases for a barangay:
```sql
SELECT c.case_number, br.complaint_number, c.respondent_name,
       c.complaint_type, c.created_at
FROM cases c
LEFT JOIN barangay_records br ON c.barangay_record_id = br.id
WHERE c.barangay_id = 5
AND c.stage = 'barangay_initial'
ORDER BY c.created_at DESC;
```

Count pending online cases:
```sql
SELECT COUNT(*) as pending FROM cases
WHERE barangay_id = 5
AND stage = 'barangay_initial'
AND status IN ('PENDING_BARANGAY', 'FILED');
```

Link between case and barangay record:
```sql
-- Find barangay record for a case:
SELECT * FROM barangay_records
WHERE online_case_id = 123;

-- Find case for a barangay record:
SELECT * FROM cases
WHERE barangay_record_id = 456;
```


ADVANTAGES OF OPTION A
======================

âœ… Compliant with Philippine Law
   - Katarungan Pambarangay requires barangay first
   - Proper escalation hierarchy

âœ… Unified System
   - All cases (online and manual) in one pipeline
   - Single source of truth
   - Consistent tracking

âœ… Fair Access to Justice
   - Affordable barangay mediation first
   - Before expensive court proceedings
   - Accessible to poor and marginalized

âœ… Better Statistics
   - Can track settlement rate
   - Identify cases resolved at barangay level
   - Monitor escalation patterns

âœ… Audit Trail
   - All cases have complete history
   - From online filing through all stages
   - Compliance ready

âœ… Workload Distribution
   - Barangay handles early resolution
   - Reduces court burden
   - More efficient system


TESTING THE NEW WORKFLOW
=========================

STEP 1: Login as complainant
- Email: complainant@example.com
- Password: password

STEP 2: File case online
- Click "File Case"
- Fill form:
  * Barangay: Select any barangay
  * Respondent: John Doe
  * Incident: "Broke my fence"
  * Date/Time: Today's date and time
  * Location: My house
  * Category: Civil
  * Sub-type: Property dispute
- Submit

RESULT:
- Get case number: BLT-2025-XXXX
- Get barangay record: BR-202511-XXXXX
- System creates both records

STEP 3: Check Barangay Dashboard
- Login as barangay_staff
- Email: barangay@example.com
- Password: password
- Go to Barangay Dashboard
- See "Online Filed (1)" section
- Table shows the case just filed
- Click "Process" button

STEP 4: Process mediation
- Same as manual barangay processing
- Add mediation efforts
- Generate settlement document or CFA
- If CFA: automatic escalation to police

STEP 5: Check Police Dashboard
- Login as police_staff
- Email: police@example.com
- Password: password
- See the escalated case in Police Blotter
- Case number links back to barangay case


DATABASE MIGRATION STEPS
========================

If you have existing data, run these SQL commands:

1. First, apply the new migration:
   - Open phpMyAdmin
   - Select ejustice_portal database
   - Go to SQL tab
   - Copy and paste: sql/004_add_barangay_case_routing.sql
   - Click Go

2. Verify success:
   - Check that cases table has new columns
   - Check that barangay_records has online_case_id

3. If error "Column already exists":
   - The columns were already added
   - No action needed
   - Continue with testing


IMPORTANT NOTES
===============

1. BACKWARD COMPATIBILITY
   - Existing cases/barangay records not affected
   - New system works alongside old manual entry
   - Can switch between manual and online

2. TRANSACTION SAFETY
   - Both records created in single transaction
   - If error occurs, both rolled back
   - No orphaned records

3. AUDIT LOGGING
   - New case creation logged
   - All mediation steps logged
   - Escalation logged
   - Full compliance trail

4. SECURITY
   - Barangay selection validated server-side
   - Input sanitized
   - Prepared statements used throughout
   - Session-based access control

5. PERFORMANCE
   - New indexes added for fast queries
   - Joining cases and barangay_records efficient
   - Dashboard loads quickly even with many cases


FUTURE ENHANCEMENTS
====================

Possible additions to this system:

1. SMS Notification
   - Notify barangay when case filed
   - Remind complainant of hearing date
   - Alert police of escalation

2. Email Notifications
   - Case filing confirmation
   - Mediation schedule
   - Settlement generated
   - Escalation notice

3. QR Code Verification
   - Generate QR on settlement/CFA
   - Police scan to verify
   - Track document authenticity

4. Statistics Dashboard
   - Settlement rate by barangay
   - Average resolution time
   - Most common dispute types
   - Escalation patterns

5. Mobile App Integration
   - File cases via mobile
   - Check case status
   - Receive notifications
   - Upload documents

6. Integration with PNP Blotter System
   - Automatic sync with police system
   - Real-time case status
   - Cross-system queries

7. Anonymous Reporting Option
   - File without disclosing identity
   - For domestic violence cases
   - Witness reporting


TROUBLESHOOTING
===============

Q: "Filed case not showing in barangay dashboard"
A: Check that barangay_id was set correctly when filing
   - Verify cases table has barangay_id populated
   - Check barangay_record_id is linked
   - Ensure barangay_id matches dashboard barangay

Q: "Error: Barangay not found"
A: Barangay info not seeded
   - Run: php seed_demo_users.php
   - This creates demo barangays

Q: "Duplicate complaint_number error"
A: complaint_number already exists (rare, date-based)
   - Manually edit to add random suffix
   - Or wait until next month for new month code

Q: "Process button doesn't work"
A: Missing barangay_record_id link
   - Manually insert into barangay_records:
     ```sql
     INSERT INTO barangay_records (...)
     VALUES (...)
     ```
   - Then update cases.barangay_record_id

Q: "Can't select barangay in file_case form"
A: No barangays in barangay_info table
   - Run seed_demo_users.php
   - Or manually insert barangays:
     ```sql
     INSERT INTO barangay_info 
     (barangay_name, municipality, province)
     VALUES ('Barangay X', 'City', 'Province');
     ```


COMPLIANCE CHECKLIST
====================

âœ… Philippine Katarungan Pambarangay Law
âœ… RA 7160 (Local Government Code)
âœ… Barangay first principle implemented
âœ… Case escalation hierarchy maintained
âœ… Audit trail complete
âœ… Access control enforced
âœ… Data security (prepared statements)
âœ… Transaction atomicity
âœ… Backup and recovery compatible
âœ… Performance optimized

---
Implementation Date: November 25, 2025
Status: âœ… COMPLETE AND TESTED
Workflow: Complainant Online Filing â†’ Barangay â†’ Police â†’ Court
